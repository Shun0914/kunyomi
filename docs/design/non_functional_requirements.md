# 非機能要件

## 概要

本ドキュメントでは、社内ナレッジ管理システム「くんよみ」の非機能要件を定義します。
機能要件ではない、パフォーマンス、セキュリティ、可用性、運用性などの要件を記載しています。

---

## 非機能要件一覧

| 機能名 | 説明 | 実装方法 |
|--------|------|----------|
| ページ表示: 2秒以内 | 通常操作時のページ表示を2秒以内にする | Next.jsのSSG/ISR、画像最適化、CDN、APIレスポンス最適化（DBクエリのN+1問題回避、インデックス） |
| API レスポンス: 500ms 以内 | 通常クエリのAPIレスポンスを500ms以内にする | SQLAlchemyのクエリ最適化（joinedload、selectinload）、DBインデックス、キャッシュ（将来的にRedis）、接続プール |
| 検索結果表示: 1秒以内 | キーワード検索の結果表示を1秒以内にする | フルテキスト検索、DBインデックス、ページネーション、結果キャッシュ |
| 同時アクセス: 50〜100ユーザー | 初期目標として同時50〜100ユーザーに対応する | Azure App Serviceのスケーリング、DB接続プール、ロードバランサー、セッション管理 |
| 稼働率: 99%以上 | 業務時間帯の稼働率を99%以上にする | Azure App Serviceの自動再起動、ヘルスチェック（`/health`、`/health/db`）、監視アラート、冗長化 |
| HTTPS必須 | すべての通信をHTTPSで行う | Azure App ServiceのHTTPS証明書（自動）、リダイレクト設定 |
| CORS設定 | 許可オリジンを制限し、クロスオリジンリクエストを保護する | FastAPIのCORSMiddleware、環境変数で許可オリジンを管理（`ALLOWED_ORIGINS`） |
| SQLインジェクション対策 | SQLインジェクション攻撃を防止する | SQLAlchemyのORM、パラメータ化クエリ、バリデーション |
| XSS対策 | クロスサイトスクリプティング攻撃を防止する | Reactの自動エスケープ、Markdownのサニタイズ、CSPヘッダー（将来） |
| データ整合性 | トランザクション整合性を保証する | DBトランザクション（SQLAlchemy）、外部キー制約、バリデーション（Pydantic、React） |
| データバリデーション | フロント・バックエンド両方で入力データを検証する | Pydanticスキーマ（バックエンド）、Reactのフォームバリデーション（フロントエンド） |
| ログ出力 | アクセスログとエラーログを出力する | FastAPIのログミドルウェア、Uvicornのアクセスログ、Azure Application Insights |
| エラー監視 | エラーを監視・通知する | Azure Application Insights、エラートラッキング、アラート設定 |
| パフォーマンス監視 | APIレスポンスタイムやDBクエリ時間を監視する | Azure Application Insights、カスタムメトリクス、DBスロークエリログ |
| バックアップ | データベースと設定のバックアップを取得する | Azure Database for MySQLの自動バックアップ、手動バックアップ手順、復旧テスト |
| レスポンシブデザイン | モバイル端末でも利用できる | Next.jsのレスポンシブ対応、Tailwind CSSのブレークポイント、モバイルファースト設計 |
| ローディング状態の表示 | データ取得中にローディング状態を表示する | ReactのuseState、スケルトンローディング、プログレスバー |
| エラーメッセージの明確化 | エラーメッセージを分かりやすく表示する | エラーハンドリングの統一、ユーザーフレンドリーなメッセージ、エラー詳細の表示 |
| データベースマイグレーション管理 | スキーマ変更を安全に管理する | Alembic、マイグレーションスクリプト、ロールバック手順、バージョン管理 |
| 自動デプロイ | コード変更を自動的に本番環境にデプロイする | GitHub Actions、Azure App Serviceへの自動デプロイ、デプロイ通知 |

---

## 優先度の高い項目

以下は、特に重要で優先的に実装・対応すべき非機能要件です。

| 機能名 | 説明 | 実装方法 |
|--------|------|----------|
| ページ表示: 2秒以内 | 通常操作時のページ表示を2秒以内にする | Next.jsのSSG/ISR、画像最適化、CDN、APIレスポンス最適化（DBクエリのN+1問題回避、インデックス） |
| HTTPS必須 | すべての通信をHTTPSで行う | Azure App ServiceのHTTPS証明書（自動）、リダイレクト設定 |
| CORS設定 | 許可オリジンを制限し、クロスオリジンリクエストを保護する | FastAPIのCORSMiddleware、環境変数で許可オリジンを管理（`ALLOWED_ORIGINS`） |
| 稼働率: 99%以上 | 業務時間帯の稼働率を99%以上にする | Azure App Serviceの自動再起動、ヘルスチェック（`/health`、`/health/db`）、監視アラート、冗長化 |
| データ整合性 | トランザクション整合性を保証する | DBトランザクション（SQLAlchemy）、外部キー制約、バリデーション（Pydantic、React） |
| ログ出力 | アクセスログとエラーログを出力する | FastAPIのログミドルウェア、Uvicornのアクセスログ、Azure Application Insights |
| エラー監視 | エラーを監視・通知する | Azure Application Insights、エラートラッキング、アラート設定 |
| バックアップ | データベースと設定のバックアップを取得する | Azure Database for MySQLの自動バックアップ、手動バックアップ手順、復旧テスト |

---

## 分類

### パフォーマンス
- ページ表示: 2秒以内
- API レスポンス: 500ms 以内
- 検索結果表示: 1秒以内
- 同時アクセス: 50〜100ユーザー

### セキュリティ
- HTTPS必須
- CORS設定
- SQLインジェクション対策
- XSS対策

### 可用性・信頼性
- 稼働率: 99%以上

### データ整合性
- データ整合性
- データバリデーション
- データベースマイグレーション管理

### 運用・監視
- ログ出力
- エラー監視
- パフォーマンス監視
- バックアップ

### UX・使いやすさ
- レスポンシブデザイン
- ローディング状態の表示
- エラーメッセージの明確化

### CI/CD
- 自動デプロイ

---

## 実装状況

### 実装済み
- ✅ HTTPS必須（Azure App Service）
- ✅ CORS設定（FastAPI CORSMiddleware）
- ✅ SQLインジェクション対策（SQLAlchemy ORM）
- ✅ XSS対策（React自動エスケープ）
- ✅ データ整合性（DBトランザクション、外部キー制約）
- ✅ データバリデーション（Pydantic、React）
- ✅ ログ出力（Uvicorn、FastAPI）
- ✅ ヘルスチェック（`/health`、`/health/db`）
- ✅ データベースマイグレーション管理（Alembic）
- ✅ 自動デプロイ（GitHub Actions）

### 実装予定（リリース2以降）
- ⏳ パフォーマンス監視（Azure Application Insights）
- ⏳ エラー監視（Azure Application Insights）
- ⏳ バックアップ手順の整備
- ⏳ レスポンシブデザインの強化
- ⏳ キャッシュ機能（Redis）

---

## 参考資料

- `docs/design/feature_roadmap.md` - 機能一覧とリリース計画
- `docs/design/data_definition.md` - データ定義
- `docs/setup/azure_app_service_env_setup.md` - Azure App Service環境変数設定

